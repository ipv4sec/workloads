apiVersion: aam.globalsphare.com/v1alpha1
kind: WorkloadVendor
metadata:
  name: rabbitmq3
spec: |
  import "mod/context"

  parameter: {
    image: *"rabbitmq:3-management" | string
    after?: string
  }


  construct: "\(context.componentName)-deployment": {
  		apiVersion: "apps/v1"
  		kind: "Deployment"
  		metadata: {
  			name:      context.componentName
  			namespace: context.namespace
  		}
  		spec:
  			replicas: 1
  			template: {
  				metadata: labels: {
  					"app":       context.appName
  					"component": context.componentName
  				}
  				spec: {
  					if parameter["after"] != _|_ {
  								initContainers: [
  									{
  										name:  "init"
  										image: "harbor1.zlibs.com/island/centos:7"
  										command: ["/bin/sh"]
  										args: ["-c", "while true; do curl 'http://island-api.island-system/status/\(context.namespace)/\(parameter.after)' | grep '\"result\":1'; if [ $? -ne 0 ]; then sleep 4s; continue; else break; fi; done"]
  									},
  								]
  					}
  				  containers: [{
  				 	    name: "main"
  							image: parameter["image"]
  							imagePullPolicy: "IfNotPresent"
  				 }, {
  				 	    name:  "status"
  							image: "harbor1.zlibs.com/island/centos:7"
  							command: ["/bin/sh", "-c", "while true; do resp=`curl -X PUT -H 'Content-Type: application/json' -d '{\"message\": \"\(context.componentName) 部署成功\"}' http://island-api.island-system/status/\(context.namespace)/\(context.componentName)/1 | grep '\"code\":0' | wc -l `; if [[ $resp -ne 1 ]]; then sleep 30s; else sleep 3600d ; fi; done"]
  				 }]
  				 restartPolicy: "Always"
  	     }
  	   }
  	    selector: matchLabels: {
  						"app":       context.appName
  						"component": context.componentName
  			}
  }

  construct: "\(context.componentName)-service": {
  		apiVersion: "v1"
  		kind:       "Service"
  		metadata: {
  			name:      context.componentName
  			namespace: context.namespace
  		}
  		spec: {
  			selector: {
  				"app":       context.appName
  				"component": context.componentName
  			}
  			ports: [{
  				port: 1883
  				name: "port-1833"
  			},{
  				port: 4369
  				name: "port-4369"
  			},{
  				port: 5671
  				name: "port-5671"
  			},{
  				port: 5672
  				name: "port-5672"
  			},{
  				port: 8883
  				name: "port-8883"
  			},{
  				port: 15672
  				name: "port-15672"
  			},{
  				port: 25672
  				name: "port-25672"
  			},{
  				port: 61613
  				name: "port-61613"
  			},{
  				port: 61614
  				name: "port-61614"
  			}]
  			type: "ClusterIP"
  		}
  }
